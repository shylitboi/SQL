# SQL_ADVANCED 2주차 정규 과제 

## Week 2 :집합 연산자 & 그룹 함수

📌**SQL_ADVANCED 정규과제**는 매주 정해진 주제에 따라 **MySQL 공식 문서 또는 한글 블로그 자료를 참고해 개념을 정리한 후, 프로그래머스/ Solvesql / LeetCode에서 SQL 3문제**와 **추가 확인문제**를 직접 풀어보며 학습하는 과제입니다. 

이번 주는 아래의 **SQL_ADVANCED_2nd_TIL**에 나열된 주제를 중심으로 개념을 학습하고, 주차별 **학습 목표**에 맞게 정리해주세요. 정리한 내용은 GitHub에 업로드한 후, **스프레드시트의 'SQL' 시트에 링크를 제출**해주세요. 



**👀 (수행 인증샷은 필수입니다.)** 

> 프로그래머스 문제를 풀고 '정답입니다' 문구를 캡쳐해서 올려주시면 됩니다. 



## SQL_ADVANCED_2nd

**1. 집합 연산자**

### 15.2.18. UNION Clause

### 15.2.14. Set Operations with UNION, INTERSECT

- UNION, UNION ALL 중심으로 개념을 정리하고, INTERSECT, EXCEPT는 구문이 어떤 기능을 하는지 간단히만 알아봅니다. EXCEPT와 INTERSECT는 대부분 MySQL 버전에서 공식 지원되지 않기 때문에, **이번주 학습은 `UNION, UNION ALL` 만 집중적으로 정리해주세요.**

**2. 그룹 함수 (집계 함수)**

### 14.19.1. Aggregate Function Descriptions



## 🏁 주차별 학습 (Study Schedule)

| 주차  | 공부 범위               | 완료 여부 |
| ----- | ----------------------- | --------- |
| 1주차 | 서브쿼리 & CTE          | ✅         |
| 2주차 | 집합 연산자 & 그룹 함수 | ✅         |
| 3주차 | 윈도우 함수             | 🍽️         |
| 4주차 | Top N 쿼리              | 🍽️         |
| 5주차 | 계층형 질의와 셀프 조인 | 🍽️         |
| 6주차 | PIVOT / UNPIVOT         | 🍽️         |
| 7주차 | 정규 표현식             | 🍽️         |



### 공식 문서 활용 팁

>  **MySQL 공식 문서는 영어로 제공되지만, 크롬 브라우저에서 공식 문서를 열고 이 페이지 번역하기에서 한국어를 선택하면 번역된 버전으로 확인할 수 있습니다. 다만, 번역본은 문맥이 어색한 부분이 종종 있으니 영어 원문과 한국어 번역본을 왔다 갔다 하며 확인하거나, 교육팀장의 정리 예시를 참고하셔도 괜찮습니다.**



# 1️⃣ 학습 내용 

> 아래의 링크를 통해 *MySQL 공식문서*로 이동하실 수 있습니다.
>
> - 15.2.18. UNION Clause : MySQL 공식문서 
>
> https://dev.mysql.com/doc/refman/8.0/en/union.html
>
> - 15.2.14. Set Operations with UNION, INTERSECT : MySQL 공식문서
>
> https://dev.mysql.com/doc/refman/8.0/en/set-operations.html
>
> (한국어 버전) https://dart-b-official.github.io/posts/mysql-UNION/
>
> - 14.19.1. Aggregate Function Descriptions : MySQL 공식문서
>
> https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html
>
> (한국어 버전) https://dart-b-official.github.io/posts/mysql-aggregate_function/



<!-- 여기까진 그대로 둬 주세요-->

# 2️⃣ 학습 내용 정리하기

## 1. 집합 연산자

~~~
✅ 학습 목표 :
* UNION과 UNION ALL의 차이와 사용법을 이해한다.
* 중복 제거 여부, 컬럼 정렬 조건 등을 고려하여 올바르게 집합 연산자를 사용할 수 있다. 
~~~

<!-- 새롭게 배운 내용을 자유롭게 정리해주세요.-->

# MySQL UNION 및 UNION ALL 학습 정리

`UNION` 연산자는 두 개 이상의 `SELECT` 문의 결과 집합을 하나의 결과 집합으로 통합하는 데 사용됩니다. 이번 학습에서는 MySQL에서 가장 보편적으로 사용되는 집합 연산자인 `UNION`과 `UNION ALL`에 중점적으로 다룹니다.

(`INTERSECT`와 `EXCEPT`는 MySQL 8.0.31 이상 버전부터 지원되므로, 광범위한 호환성을 위해 이번 정리에서는 제외합니다.)

-----

## 1\. UNION의 기본 개념과 사용법

`UNION`은 여러 개의 `SELECT` 문을 실행하여 얻은 각 결과 집합을 하나로 합쳐서 보여줍니다.

기본적으로 `UNION`은 **중복된 행을 자동으로 제거**합니다. 이는 내부적으로 `DISTINCT` 옵션이 적용되기 때문입니다.

### 기본 예제

서로 다른 `SELECT` 문의 결과를 하나로 합치는 가장 간단한 예제입니다.

```sql
SELECT 1, 2
UNION
SELECT 'a', 'b';
```

**결과:**

```
+---+---+
| 1 | 2 |
+---+---+
| 1 | 2 |
| a | b |
+---+---+
```

-----

## 2\. UNION vs. UNION ALL

`UNION`과 `UNION ALL`의 가장 핵심적인 차이는 **중복 값 처리 방식**에 있습니다.

  * **`UNION`**: 결과 집합을 합친 후, **중복된 행을 모두 제거**합니다. (기본값)
  * **`UNION ALL`**: 중복 제거 과정을 거치지 않고, **모든 행을 그대로 반환**합니다.

성능적인 측면에서는 중복을 검사하는 과정이 없으므로 `UNION ALL`이 `UNION`보다 일반적으로 더 빠릅니다. 따라서 중복된 결과가 존재하지 않음을 알거나, 중복이 허용되는 상황에서는 `UNION ALL`을 사용하는 것이 효율적입니다.

```sql
-- t1 테이블에 (1), (2)가 있고, t2 테이블에 (1), (3)이 있다고 가정

-- UNION: 중복된 1은 한 번만 표시됨
SELECT a FROM t1 UNION SELECT a FROM t2;
-- 결과: 1, 2, 3

-- UNION ALL: 모든 결과를 그대로 합쳐서 보여줌
SELECT a FROM t1 UNION ALL SELECT a FROM t2;
-- 결과: 1, 2, 1, 3
```

-----

## 3\. UNION 사용 시 핵심 규칙

`UNION`을 사용하기 위해서는 몇 가지 규칙을 준수해야 합니다.

### **컬럼의 일치**

결합하려는 모든 `SELECT` 문은 동일한 수의 컬럼을 가져야 하며, 각 컬럼은 서로 호환되는 데이터 타입을 가져야 합니다. 컬럼의 순서 또한 중요하게 작용합니다.

  * **결과 집합의 컬럼명**: 최종 결과 집합의 컬럼 이름은 **첫 번째 `SELECT` 문**의 컬럼명을 따릅니다.
  * **데이터 타입 변환**: 만약 각 `SELECT` 문의 컬럼 타입이 다른 경우, MySQL은 모든 값을 포괄할 수 있는 타입으로 자동 변환합니다.

<!-- end list -->

```sql
-- 첫 번째 SELECT의 CHAR(1)과 두 번째 SELECT의 CHAR(20)을 모두 포함할 수 있는
-- 더 큰 타입으로 결과 컬럼의 타입이 결정됩니다.
SELECT REPEAT('a',1) UNION SELECT REPEAT('b',20);
```

-----

## 4\. 정렬 및 결과 제한 (ORDER BY, LIMIT)

`ORDER BY`와 `LIMIT` 절은 `UNION`의 전체 결과에 적용하거나, 각 `SELECT`문에 개별적으로 적용할 수 있습니다.

### **전체 결과에 대한 적용**

`UNION`으로 결합된 **전체 결과 집합**에 대해 정렬하거나 개수를 제한하려면, 마지막 `SELECT` 문 뒤에 `ORDER BY` 또는 `LIMIT` 절을 추가합니다.

```sql
SELECT a FROM t1
UNION
SELECT a FROM t2
ORDER BY a DESC LIMIT 10;
```

**주의**: `ORDER BY` 절에서는 첫 번째 `SELECT` 문에서 정의한 컬럼명(또는 별칭)을 사용해야 합니다.

### **개별 쿼리에 대한 적용**

각각의 `SELECT` 문에 `ORDER BY`나 `LIMIT`을 적용하려면, 해당 `SELECT` 문을 **괄호 `()`로 묶어야 합니다.**

```sql
(SELECT a FROM t1 WHERE a > 10 ORDER BY a LIMIT 5)
UNION
(SELECT a FROM t2 WHERE a < 5 ORDER BY a DESC LIMIT 5);
```

-----

## 5\. MySQL 8.0에서의 주요 변경사항 및 제약

MySQL 8.0부터 `UNION` 처리 방식이 더 일관성 있게 변경되면서 몇 가지 중요한 문법적 변화가 생겼습니다.

### **잠금 절 (Locking Clause) 사용**

`FOR UPDATE`나 `LOCK IN SHARE MODE`와 같은 잠금 절을 `UNION`과 함께 사용하려면, 해당 절을 포함하는 각 `SELECT` 문을 반드시 **괄호 `()`로 묶어야 합니다.**

  * **잘못된 사용 (MySQL 8.0부터 허용되지 않음):**

    ```sql
    SELECT 1 FOR UPDATE UNION SELECT 1 FOR UPDATE;
    ```

  * **올바른 사용:**

    ```sql
    (SELECT 1 FOR UPDATE) UNION (SELECT 1 FOR UPDATE);
    ```

### **기타 제약 사항**

  * **`INTO` 절**: `UNION`을 사용한 전체 문장의 가장 마지막에만 `INTO` 절을 사용할 수 있습니다.
  * **집계 함수**: `UNION` 결과에 대한 `ORDER BY` 절에서는 `MAX()`, `SUM()`과 같은 집계 함수를 사용할 수 없습니다.



## 2. 그룹함수

~~~
✅ 학습 목표 :
* COUNT, SUM, AVG, MAX, MIN 함수의 기본 사용법을 익힌다.
* GROUP BY와 HAVING 절을 적절히 활용할 수 있다.
* NULL과 집계 함수가 어떻게 상호작용하는지 이해한다. 
~~~

<!-- 새롭게 배운 내용을 자유롭게 정리해주세요.-->


# MySQL 그룹 함수 (집계 함수) 핵심 정리 📊

그룹 함수는 여러 행의 데이터를 바탕으로 **단일 요약 값**을 계산하는 데 사용됩니다. `GROUP BY` 절과 함께 사용하여 특정 그룹별로 데이터를 집계하는 데 필수적인 기능입니다.

-----

## 1\. 핵심 집계 함수

대부분의 데이터 분석 작업에서 가장 빈번하게 사용되는 필수 함수들입니다.

### **`COUNT()` - 개수 세기**

지정된 조건에 맞는 행의 개수를 반환합니다. `BIGINT` 타입을 결과로 내놓습니다.

  * `COUNT(expr)`: `expr`이 `NULL`이 아닌 행의 개수를 셉니다.
  * `COUNT(*)`: 전체 행의 개수를 셉니다. (`NULL` 여부와 관계없음)
  * `COUNT(DISTINCT expr)`: 중복을 제외한 `expr` 값의 개수를 셉니다.

<!-- end list -->

```sql
-- 학생별로 수강하는 과목의 수를 계산
SELECT
    student_name,
    COUNT(*) AS course_count
FROM course
GROUP BY student_name;
```

> **💡 `COUNT(*)` vs `COUNT(1)`**
> 성능상 차이는 거의 없습니다. MySQL 옵티마이저는 두 표현식을 동일하게 해석하므로, 관례적으로 더 명확한 `COUNT(*)`를 사용하는 것을 권장합니다.

### **`SUM()` & `AVG()` - 합계와 평균**

숫자 데이터의 합계와 평균을 계산합니다. `NULL` 값은 계산에서 제외됩니다.

  * `SUM(expr)`: `expr`의 총합을 구합니다.
  * `AVG(expr)`: `expr`의 평균을 구합니다.
  * `DISTINCT` 키워드를 사용하여 중복되지 않는 값들만을 대상으로 계산할 수도 있습니다.

<!-- end list -->

```sql
-- 학생별 시험 점수의 총점과 평균 점수를 계산
SELECT
    student_name,
    SUM(test_score) AS total_score,
    AVG(test_score) AS average_score
FROM student_scores
GROUP BY student_name;
```

### **`MAX()` & `MIN()` - 최댓값과 최솟값**

그룹 내에서 가장 큰 값과 가장 작은 값을 찾습니다. 숫자뿐만 아니라 문자열이나 날짜/시간 타입에도 사용할 수 있습니다.

  * `MAX(expr)`: `expr`의 최댓값을 찾습니다.
  * `MIN(expr)`: `expr`의 최솟값을 찾습니다.

<!-- end list -->

```sql
-- 과목별 최고 점수와 최저 점수를 조회
SELECT
    subject,
    MAX(score) AS highest_score,
    MIN(score) AS lowest_score
FROM test_results
GROUP BY subject;
```

### **`GROUP_CONCAT()` - 문자열 연결**

그룹 내의 여러 행에 있는 문자열 값을 하나의 긴 문자열로 합쳐줍니다.

  * **`SEPARATOR`**: 값들을 구분할 문자열을 지정합니다. (기본값: `,`)
  * **`ORDER BY`**: 연결될 문자열의 순서를 정렬할 수 있습니다.
  * **`DISTINCT`**: 중복된 값을 제외하고 연결합니다.

<!-- end list -->

```sql
-- 학생 이름을 기준으로, 해당 학생이 응시한 모든 시험 과목을 한 줄로 나열
SELECT
    student_name,
    GROUP_CONCAT(subject ORDER BY subject ASC SEPARATOR ', ') AS subjects_taken
FROM student_exams
GROUP BY student_name;
```

> **⚠️ 주의\!**
> `GROUP_CONCAT`으로 생성되는 문자열의 최대 길이는 `group_concat_max_len` 시스템 변수에 의해 제한됩니다. (기본값: 1024) 더 긴 문자열이 필요하면 이 값을 세션 또는 전역으로 늘려야 합니다.

-----

## 2\. 고급 집계 함수

특정 데이터 타입이나 통계 분석에 특화된 함수들입니다.

### **JSON 집계 함수 (MySQL 8.0+)**

행 데이터를 JSON 배열이나 객체로 쉽게 집계할 수 있습니다.

  * `JSON_ARRAYAGG(col)`: 컬럼의 값들을 모아 **JSON 배열**을 생성합니다.
  * `JSON_OBJECTAGG(key, value)`: 키-값 쌍을 모아 **JSON 객체**를 생성합니다.

<!-- end list -->

```sql
-- 사용자 ID별로 권한 목록을 JSON 배열로 생성
SELECT
    user_id,
    JSON_ARRAYAGG(permission) AS permissions
FROM user_permissions
GROUP BY user_id;

-- 설정 테이블의 키-값 데이터를 하나의 JSON 객체로 통합
SELECT
    JSON_OBJECTAGG(config_key, config_value) AS configuration
FROM system_config;
```

> **💡 `JSON_OBJECTAGG` 중복 키 처리**
> 만약 그룹 내에 동일한 `key`가 여러 개 존재하면, 어떤 `value`가 선택될지 보장되지 않습니다. (일반적으로 마지막 행의 값이 선택됨) 일관된 결과를 원한다면 서브쿼리나 윈도우 함수를 활용하여 순서를 제어해야 합니다.

### **통계 함수 (분산 및 표준편차)**

데이터의 분포를 파악하기 위한 통계 값을 계산합니다.

  * **모집단(Population)**: 전체 데이터를 대상으로 계산
      * `VAR_POP(expr)` 또는 `VARIANCE(expr)`: 모분산
      * `STDDEV_POP(expr)` 또는 `STD(expr)`: 모표준편차
  * **표본(Sample)**: 일부 샘플 데이터를 대상으로 계산
      * `VAR_SAMP(expr)`: 표본분산
      * `STDDEV_SAMP(expr)`: 표본표준편차

### **비트(Bitwise) 집계 함수**

정수 값에 대한 비트 단위 연산을 수행합니다.

  * `BIT_AND(expr)`: 모든 값에 대한 비트 AND 연산
  * `BIT_OR(expr)`: 모든 값에 대한 비트 OR 연산
  * `BIT_XOR(expr)`: 모든 값에 대한 비트 XOR 연산

-----

## 3\. 집계 함수 공통 규칙 및 주의사항

  * **NULL 값 처리**: 별도의 언급이 없는 한, 모든 집계 함수는 계산 시 `NULL` 값을 **무시**합니다. (단, `COUNT(*)`는 예외)
  * **`GROUP BY`의 생략**: `GROUP BY` 절 없이 집계 함수를 사용하면, 조회 대상이 되는 **전체 행을 하나의 그룹**으로 간주하여 결과를 계산합니다.
  * **데이터 타입**: `SUM`, `AVG` 같은 함수는 숫자형 인자를 기대하며, 필요 시 다른 타입을 숫자로 캐스팅하여 처리합니다. 시간/날짜 타입은 의도치 않은 결과가 나올 수 있으므로 `TIME_TO_SEC` 같은 함수로 변환 후 사용하는 것이 안전합니다.
  * **윈도우 함수**: 대부분의 집계 함수는 `OVER (...)` 절과 함께 사용하여 윈도우 함수로도 활용할 수 있습니다. 이를 통해 그룹화하지 않고도 파티션별 집계 값을 유연하게 계산할 수 있습니다.


<br><br>

---

# 3️⃣ 실습 문제

https://leetcode.com/problems/customers-who-never-order/

> LeetCode 183. Customers Who never Order
>
> 학습 포인트 : 주문 내역이 없는 고객을 찾기 위한 패턴 익히기  

https://leetcode.com/problems/department-highest-salary/description/

> LeetCode 184. Department Highest Salary
>
> 학습 포인트 : 부서별 최고 연봉자 추출을 위한 **그룹별 정렬 / 필터링** 방식 이해하기

---

## 문제 인증란

<!-- 이 주석을 지우고 여기에 문제 푼 인증사진을 올려주세요. -->

![]()

![]()

---

# 확인문제

## 문제 1

> **🧚동혁이는 SQL 문제를 풀면서 `UNION과 UNION ALL`의 차이를 명확히 이해하지 못해 중복된 값이 생기거나 누락되는 문제를 계속 겪고 있습니다.** 아래는 동혁이가 작성한 쿼리입니다.

~~~sql
SELECT name FROM member
UNION
SELECT name FROM blackList;
~~~

> **그런데 예상과 달리 blacklist에만 있는 이름이 결과에 안 나오거나, 중복된 이름이 사라져서 헷갈리고 있습니다. UNION과 UNION ALL의 차이를 설명하고, 중복 포함 여부에 따라 어떤 경우에 어떤 쿼리를 써야 하는지 예시와 함께 설명해주세요**

<br>

~~~
UNION과 UNION ALL의 가장 큰 차이는 중복 값을 처리 여부

UNION: 중복을 제거
UNION은 두 목록을 합친 후, 중복되는 항목은 하나만 남김

UNION ALL: 중복을 포함한 목록 
UNION ALL은 두 목록을 그대로 이어 붙여 중복 여부와 상관없이 모든 항목을 보여줌

~~~

## 참고자료
그룹 함수가 많아서 중요하게 많이 쓰이는 함수들을 정리해놓은 참고자료를 첨부합니다. 아래 블로그를 통해서 더욱 쉽게 공부해보시고 문제를 풀어보세요.
1. [SQL 10] 그룹 함수, GROUP BY 절, HAVING 절
https://keep-cool.tistory.com/37

또한, MySQL 문서 이외에 Oracle 함수에서 사용하는 그룹함수에 대한 소개도 같이 첨부합니다. SQLD 시험 준비하시는 분이 있다면 이 자격증 시험에서는 Oracle 언어를 기반으로 문제가 출제하오니 아래 블로그도 같이 공부해보세요. (선택사항입니다.)
2. 그룹 함수 (Group FUNCTION)
https://dkkim2318.tistory.com/48

<br>

### 🎉 수고하셨습니다.